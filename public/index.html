<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Live Collab - E2E</title><link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css"><style>*{box-sizing:border-box;margin:0;padding:0}:root{--bg:#1a1a2e;--panel:#16213e;--border:#0f3460;--accent:#e94560;--text:#eee;--muted:#94a3b8;--success:#22c55e;--warning:#f59e0b}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden}header{display:flex;align-items:center;padding:0.75rem 1rem;background:var(--panel);border-bottom:1px solid var(--border);gap:1rem}.logo{font-size:1.25rem;font-weight:700;color:var(--accent);display:flex;align-items:center;gap:0.5rem}.room-url{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:0.5rem 0.75rem;color:var(--muted);font-family:monospace;font-size:0.875rem;cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:400px}.room-url:hover{background:var(--border)}.status{display:flex;align-items:center;gap:0.5rem;font-size:0.875rem}.status-dot{width:8px;height:8px;border-radius:50%;background:var(--success)}.status-dot.offline{background:var(--accent)}.btn{background:var(--accent);color:white;border:none;border-radius:6px;padding:0.5rem 1rem;font-size:0.875rem;cursor:pointer;display:flex;align-items:center;gap:0.5rem}.btn:hover{opacity:0.9}.btn-secondary{background:var(--border)}.toolbar{display:flex;align-items:center;padding:0.5rem 1rem;background:var(--panel);border-bottom:1px solid var(--border);gap:0.75rem}.toolbar select{background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:0.375rem 0.5rem;font-size:0.875rem}.version-badge{margin-left:auto;font-size:0.75rem;color:var(--muted);background:var(--bg);padding:0.25rem 0.5rem;border-radius:4px}main{flex:1;display:flex;overflow:hidden}.sidebar{width:280px;min-width:150px;max-width:600px;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;position:relative}.sidebar-resize{position:absolute;top:0;right:0;width:4px;height:100%;cursor:ew-resize;background:transparent;z-index:10}.sidebar-resize:hover,.sidebar-resize.dragging{background:var(--accent)}.file-tree{flex:1;overflow-y:auto;padding:0.5rem}.tree-item{display:flex;align-items:center;padding:0.375rem 0.5rem;border-radius:4px;cursor:pointer;font-size:0.875rem;gap:0.5rem}.tree-item:hover{background:var(--border)}.tree-item.selected{background:var(--accent)}.tree-item.folder{font-weight:500}.tree-item.non-syncable{color:var(--muted);opacity:0.7}.tree-item .icon{width:16px;text-align:center}.tree-item .name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.tree-item .size{font-size:0.75rem;color:var(--muted)}.tree-children{padding-left:1rem}.sidebar-actions{padding:0.75rem;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:0.5rem}.sidebar-actions button{width:100%;justify-content:center}.editor-panel{flex:1;display:flex;flex-direction:column;overflow:hidden}.file-header{padding:0.75rem 1rem;background:var(--bg);border-bottom:1px solid var(--border);font-family:monospace;font-size:0.875rem;color:var(--muted)}.editor-container{flex:1;overflow:auto;position:relative}.editor{width:100%;height:100%;background:var(--bg);color:var(--text);border:none;resize:none;padding:1rem;font-family:"Fira Code","Monaco","Menlo",monospace;font-size:14px;line-height:1.6;tab-size:2;outline:none}.CodeMirror{height:100% !important;font-family:"Fira Code","Monaco","Menlo",monospace;font-size:14px;line-height:1.6}.editor-container .CodeMirror{background:var(--bg)}.code-view{padding:1rem;margin:0;overflow:auto;height:100%}.code-view code{font-family:"Fira Code","Monaco","Menlo",monospace;font-size:14px;line-height:1.6}.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--muted);gap:1rem}.empty-state h2{font-size:1.5rem;color:var(--text)}.empty-state p{max-width:400px;text-align:center;line-height:1.5}.changeset-banner{background:var(--warning);color:#000;padding:0.75rem 1rem;display:flex;align-items:center;gap:1rem}.changeset-banner .message{flex:1;font-weight:500}.changeset-banner .btn{background:#000;color:var(--warning)}.diff-view{padding:1rem;font-family:monospace;font-size:14px;line-height:1.6;white-space:pre-wrap;overflow:auto}.diff-line{padding:0 0.5rem}.diff-line.added{background:rgba(34,197,94,0.2);color:var(--success)}.diff-line.removed{background:rgba(233,69,96,0.2);color:var(--accent)}.diff-line.header{color:var(--muted)}.change-card{border:1px solid var(--border);border-radius:8px;margin:1rem;overflow:hidden}.change-card-header{background:var(--panel);padding:0.75rem 1rem;display:flex;align-items:center;gap:1rem;border-bottom:1px solid var(--border)}.change-card-header .path{flex:1;font-family:monospace;font-size:0.875rem}.change-card-actions{display:flex;gap:0.5rem}.change-card-actions .btn{padding:0.375rem 0.75rem;font-size:0.75rem}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:100}.modal{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:1.5rem;max-width:500px;width:90%}.modal h3{margin-bottom:1rem}.modal input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:0.75rem;color:var(--text);font-size:1rem;margin-bottom:1rem}.modal-actions{display:flex;gap:0.75rem;justify-content:flex-end}.hidden{display:none !important}.toast{position:fixed;bottom:1rem;right:1rem;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem;z-index:200;animation:slideIn 0.2s ease}.toast.success{border-color:var(--success)}.toast.error{border-color:var(--accent)}@keyframes slideIn{from{transform:translateY(1rem);opacity:0}to{transform:translateY(0);opacity:1}}</style></head><body><header><div class="logo"><span>&#128274;</span><span>Live Collab</span></div><div class="room-url" id="roomUrl" onclick="copyRoomUrl()"></div><button class="btn" onclick="copyRoomUrl()">Share</button><button class="btn btn-secondary" onclick="showQRCode()" title="QR code (for browser isolation)">QR</button><button class="btn btn-secondary" id="passwordBtn" onclick="showSetPasswordModal()" title="Set room password">&#128272;</button><button class="btn btn-danger" onclick="confirmKillRoom()" title="Delete Room" style="background:#e94560;color:white;border:none">&#128163;</button><div class="status"><span id="isolationWarning" style="display:none;background:#e94560;color:white;padding:2px 6px;border-radius:4px;font-size:0.75rem;cursor:pointer" onclick="runComprehensiveIsolationCheck()" title="Browser isolation detected - click for detailed analysis">ISOLATED</span><span id="passwordStatus" style="display:none">&#128274;</span><span>&#128274; E2E</span><div class="status-dot" id="statusDot"></div><span id="statusText">Online</span></div></header><div class="toolbar"><input type="text" id="fileSearch" placeholder="Search files..." oninput="filterFiles()" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:0.375rem 0.5rem;color:var(--text);font-size:0.875rem;width:200px;"><button class="btn btn-secondary" onclick="copyCode()">Copy</button><button class="btn btn-secondary" onclick="downloadAll()">Download All</button><div class="version-badge">v<span id="versionBadge">0</span></div></div><div id="changesetBanner" class="changeset-banner hidden"><span class="message" id="changesetMessage"></span><button class="btn" onclick="acceptAllChanges()">&#10003; Accept All</button><button class="btn btn-secondary" onclick="rejectAllChanges()">&#10007; Reject All</button></div><main><aside class="sidebar" id="sidebar"><div class="sidebar-resize" id="sidebarResize"></div><div style="display:flex;gap:0.5rem;padding:0.5rem;border-bottom:1px solid var(--border)"><button class="btn btn-secondary" onclick="expandAll()" style="flex:1;padding:0.25rem;font-size:0.75rem" title="Expand All">&#9660; Expand</button><button class="btn btn-secondary" onclick="collapseAll()" style="flex:1;padding:0.25rem;font-size:0.75rem" title="Collapse All">&#9654; Collapse</button></div><div class="file-tree" id="fileTree"></div><div class="sidebar-actions"><button class="btn btn-secondary" onclick="showAddFileModal()">+ Add File</button><button class="btn btn-secondary" onclick="showAddDirModal()">+ Add Directory</button><button class="btn btn-secondary" onclick="uploadFolder()">&#128193; Upload Folder</button><button class="btn btn-secondary" id="saveToDiskBtn" onclick="saveToDisk()" style="display:none">&#128190; Save to Disk</button><input type="file" id="folderInput" webkitdirectory multiple style="display:none" onchange="handleFolderUpload(event)"></div></aside><section class="editor-panel"><div class="file-header" id="fileHeader">No file selected</div><div class="editor-container" id="editorContainer"><div class="empty-state" id="emptyState"><h2>&#128274; Live Collab</h2><p>E2E real-time collab. Upload a folder or create a file to get started.</p></div><div id="editorWrapper" class="hidden" style="height:100%"></div><div class="diff-view hidden" id="diffView"></div></div></section></main><div id="addFileModal" class="modal-overlay hidden" onclick="if(event.target===this)hideAddFileModal()"><div class="modal"><h3>Add New File</h3><input type="text" id="newFilePath" placeholder="path/to/file.js" onkeydown="if(event.key==='Enter')createNewFile()"><div class="modal-actions"><button class="btn btn-secondary" onclick="hideAddFileModal()">Cancel</button><button class="btn" onclick="createNewFile()">Create</button></div></div></div><div id="addDirModal" class="modal-overlay hidden" onclick="if(event.target===this)hideAddDirModal()"><div class="modal"><h3>Add New Directory</h3><input type="text" id="newDirPath" placeholder="path/to/directory" onkeydown="if(event.key==='Enter')createNewDir()"><p style="font-size:0.75rem;color:var(--muted);margin-top:0.5rem">Creates an empty .gitkeep file in the directory</p><div class="modal-actions"><button class="btn btn-secondary" onclick="hideAddDirModal()">Cancel</button><button class="btn" onclick="createNewDir()">Create</button></div></div></div><div id="passwordModal" class="modal-overlay hidden"><div class="modal"><h3 id="passwordModalTitle">Enter Room Password</h3><input type="password" id="passwordInput" placeholder="Password" onkeydown="if(event.key==='Enter')submitPassword()"><p id="passwordError" style="color:var(--accent);font-size:0.875rem;margin-bottom:1rem;display:none"></p><div class="modal-actions"><button class="btn" onclick="submitPassword()">Enter</button></div></div></div><div id="setPasswordModal" class="modal-overlay hidden" onclick="if(event.target===this)hideSetPasswordModal()"><div class="modal"><h3>Set Room Password</h3><p style="font-size:0.875rem;color:var(--muted);margin-bottom:1rem">Protect this room with a password. Others will need it to access.</p><input type="password" id="setPasswordInput" placeholder="New password (min 4 chars)" onkeydown="if(event.key==='Enter')setRoomPassword()"><input type="password" id="setPasswordConfirm" placeholder="Confirm password" style="margin-top:0.5rem" onkeydown="if(event.key==='Enter')setRoomPassword()"><p id="setPasswordError" style="color:var(--accent);font-size:0.875rem;margin-top:0.5rem;display:none"></p><div class="modal-actions"><button class="btn btn-secondary" onclick="hideSetPasswordModal()">Cancel</button><button class="btn" onclick="setRoomPassword()">Set Password</button></div></div></div><div id="qrModal" class="modal-overlay hidden" onclick="if(event.target===this)hideQRCode()"><div class="modal" style="text-align:center;max-width:360px"><h3>Scan to Share</h3><p style="font-size:0.875rem;color:var(--muted);margin-bottom:1rem">Use this if copy/paste is blocked (browser isolation)</p><div id="qrCode" style="background:white;padding:1rem;border-radius:8px;display:inline-block"></div><p style="font-size:0.75rem;color:var(--muted);margin-top:1rem;word-break:break-all" id="qrUrlDisplay"></p><div class="modal-actions" style="margin-top:1rem"><button class="btn btn-secondary" onclick="hideQRCode()">Close</button></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/go/go.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/rust/rust.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/ruby/ruby.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/php/php.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/swift/swift.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/yaml/yaml.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/shell/shell.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script><script>const roomId=window.location.pathname.split("/").pop();let encryptionKey=null,cryptoKey=null,version=0,files=[],changesets=[],selectedFile=null,dirHandle=null,isPolling=!1,saveTimeout=null,lastActivityTime=0;const POLLING_PAUSE_MS=2e3;let cmEditor=null,roomPassword=sessionStorage.getItem("room_password_"+roomId)||"",hasPassword=!1,opSeq=0,pendingOps=[],isApplyingRemoteOps=!1,opSendTimeout=null;const OP_SEND_DELAY=100,OP_POLL_INTERVAL=1e3,SNAPSHOT_THRESHOLD=50;let opsSinceSnapshot=0,opPollInterval=null;const USE_DISGUISED_API=!0,STANDARD_SIZES=[256,512,1024,2048,4096,8192,16384];function randomJitter(e,t){return new Promise(o=>setTimeout(o,e+Math.random()*(t-e)))}function generatePadding(e){let t="";for(let o=0;o<e;o++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".charAt(Math.floor(64*Math.random()));return t}function padPayload(e){if(!e)return e;try{const t={...e,_analytics:{session_id:generateClientId(),view_time:Math.floor(performance.now()),scroll_depth:Math.random(),interaction_count:Math.floor(50*Math.random())},_meta:{client_ts:Date.now(),tz_offset:(new Date).getTimezoneOffset()}},o=JSON.stringify(t),n=(new TextEncoder).encode(o).length,a=STANDARD_SIZES.find(e=>e>n+50)||n+1024,s=Math.max(0,a-n-20);return s>0&&(t._pad=generatePadding(s)),t}catch(t){return e}}function getDecoyHeaders(){return{"X-Client-Version":"2.4.1","X-Request-ID":"req_"+Date.now().toString(36)+Math.random().toString(36).slice(2,6),"X-Session-Start":sessionStorage.getItem("session_start")||Date.now().toString(),"X-Feature-Flags":"darkmode,neweditor,v2api,realtime_cursors","X-Device-Type":"desktop","X-Timezone":Intl.DateTimeFormat().resolvedOptions().timeZone}}sessionStorage.getItem("session_start")||sessionStorage.setItem("session_start",Date.now().toString());const BIP39_WORDS=["abandon","ability","able","about","above","absent","absorb","abstract","absurd","abuse","access","accident","account","accuse","achieve","acid","acoustic","acquire","across","act","action","actor","actress","actual","adapt","add","addict","address","adjust","admit","adult","advance","advice","aerobic","affair","afford","afraid","again","age","agent","agree","ahead","aim","air","airport","aisle","alarm","album","alcohol","alert","alien","all","alley","allow","almost","alone","alpha","already","also","alter","always","amateur","amazing","among","amount","amused","analyst","anchor","ancient","anger","angle","angry","animal","ankle","announce","annual","another","answer","antenna","antique","anxiety","any","apart","apology","appear","apple","approve","april","arch","arctic","area","arena","argue","arm","armed","armor","army","around","arrange","arrest","arrive","arrow","art","artefact","artist","artwork","ask","aspect","assault","asset","assist","assume","asthma","athlete","atom","attack","attend","attitude","attract","auction","audit","august","aunt","author","auto","autumn","average","avocado","avoid","awake","aware","away","awesome","awful","awkward","axis","baby","bachelor","bacon","badge","bag","balance","balcony","ball","bamboo","banana","banner","bar","barely","bargain","barrel","base","basic","basket","battle","beach","bean","beauty","become","beef","before","begin","behave","behind","believe","below","belt","bench","benefit","best","betray","better","between","beyond","bicycle","bid","bike","bind","biology","bird","birth","bitter","black","blade","blame","blanket","blast","bleak","bless","blind","blood","blossom","blouse","blue","blur","blush","board","boat","body","boil","bomb","bone","bonus","book","boost","border","boring","borrow","boss","bottom","bounce","box","boy","bracket","brain","brand","brass","brave","bread","breeze","brick","bridge","brief","bright","bring","brisk","broccoli","broken","bronze","broom","brother","brown","brush","bubble","buddy","budget","buffalo","build","bulb","bulk","bullet","bundle","bunker","burden","burger","burst","bus","business","busy","butter"];function keyToWords(e){const t=Uint8Array.from(atob(e.replace(/-/g,"+").replace(/_/g,"/")+"="),e=>e.charCodeAt(0)),o=[];for(let e=0;e<t.length;e+=2){const n=t[e]<<3|t[e+1]>>5;o.push(BIP39_WORDS[n%BIP39_WORDS.length])}return o.slice(0,8).join("-")}function wordsToKey(e){const t=e.split("-"),o=new Uint8Array(32);for(let e=0;e<t.length&&e<16;e++){const n=BIP39_WORDS.indexOf(t[e].toLowerCase());if(-1===n)return null;const a=2*e;o[a]=n>>3&255,a+1<32&&(o[a+1]=(7&n)<<5|31&o[a+1])}return btoa(String.fromCharCode(...o)).replace(/[+\/=]/g,e=>"+"===e?"-":"/"===e?"_":"").slice(0,43)}const API={roomState:(e=0,t=1e3,o=0)=>`/api/workspace/${roomId}${`?since=${e}&limit=${t}&offset=${o}`}`,roomInfo:()=>`/api/workspace/${roomId}/info`,roomVersion:()=>`/api/workspace/${roomId}/status`,syncBegin:()=>`/api/workspace/${roomId}/session`,syncChunk:()=>"/api/documents/batch",syncComplete:()=>`/api/workspace/${roomId}/finalize`,ops:()=>"/api/documents",files:()=>"/api/documents/save",deleteRoom:()=>`/api/room/${roomId}`};async function initEncryption(){const e=window.location.hash.slice(1);if(e&&e.length>=32)encryptionKey=e;else{const e=crypto.getRandomValues(new Uint8Array(32));encryptionKey=btoa(String.fromCharCode(...e)).replace(/[+\/=]/g,e=>"+"===e?"-":"/"===e?"_":"").slice(0,43),window.location.hash=encryptionKey}const t=Uint8Array.from(atob(encryptionKey.replace(/-/g,"+").replace(/_/g,"/")+"="),e=>e.charCodeAt(0));cryptoKey=await crypto.subtle.importKey("raw",t,"AES-GCM",!1,["encrypt","decrypt"]),document.getElementById("roomUrl").textContent=window.location.href}async function encrypt(e){const t=crypto.getRandomValues(new Uint8Array(12)),o=(new TextEncoder).encode(e),n=await crypto.subtle.encrypt({name:"AES-GCM",iv:t},cryptoKey,o),a=new Uint8Array(t.length+n.byteLength);a.set(t),a.set(new Uint8Array(n),t.length);let s="";for(let e=0;e<a.length;e+=8192)s+=String.fromCharCode(...a.subarray(e,e+8192));return btoa(s)}async function decrypt(e){if(!e)return"";try{const t=Uint8Array.from(atob(e),e=>e.charCodeAt(0)),o=t.slice(0,12),n=t.slice(12),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:o},cryptoKey,n);return(new TextDecoder).decode(a)}catch(e){return console.error("Decryption failed:",e),"[Decryption Error]"}}async function hashPath(e){const t=(new TextEncoder).encode(e),o=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(o)).map(e=>e.toString(16).padStart(2,"0")).join("")}function posToOffset(e,t){let o=0;for(let n=0;n<t.line;n++)o+=e.getLine(n).length+1;return o+=t.ch,o}function offsetToPos(e,t){let o=t;for(let t=0;t<e.lineCount();t++){const n=e.getLine(t).length+1;if(o<n)return{line:t,ch:o};o-=n}const n=e.lineCount()-1;return{line:n,ch:e.getLine(n).length}}function captureLocalOp(e,t){if(isApplyingRemoteOps)return;if(!selectedFile||!selectedFile.is_syncable)return;const o=posToOffset(e.getDoc(),t.from),n=t.removed.join("\n"),a=t.text.join("\n"),s={file_path:selectedFile.path,pos:o,del:n.length,ins:a};pendingOps.push(s),scheduleSendOps()}function scheduleSendOps(){clearTimeout(opSendTimeout),opSendTimeout=setTimeout(sendPendingOps,100)}async function sendPendingOps(){if(0===pendingOps.length)return;const e=pendingOps.splice(0,pendingOps.length),t=generateClientId();for(const o of e)try{const e=await hashPath(o.file_path),n={pos:o.pos,del:o.del,ins:o.ins},a=await encrypt(JSON.stringify(n));let s,i;s=`/api/documents/${e}/edits`,i={workspace_id:roomId,edit_data:a,author_id:t,base_revision:selectedFile.version||0};const r=await apiFetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(r.ok){const e=await r.json();opSeq=Math.max(opSeq,e.revision),opsSinceSnapshot++,opsSinceSnapshot>=50&&(await snapshotFile(selectedFile),opsSinceSnapshot=0)}}catch(e){console.error("Failed to send op:",e),pendingOps.unshift(o)}}async function pollOps(){if(selectedFile&&selectedFile.is_syncable)try{let e;e=`/api/documents/${await hashPath(selectedFile.path)}/edits?workspace=${roomId}&since=${opSeq}`;const t=await apiFetch(e);if(t.ok){const e=await t.json(),o=generateClientId(),n=e.edits;for(const e of n)if(e.author_id!==o)try{const t=e.data;applyRemoteOp(JSON.parse(await decrypt(t)))}catch(e){console.error("Failed to apply op:",e)}opSeq=e.current_revision}}catch(e){console.error("Op poll error:",e)}}function applyRemoteOp(e){if(cmEditor){isApplyingRemoteOps=!0;try{const t=cmEditor.getDoc(),o=offsetToPos(t,e.pos),n=offsetToPos(t,e.pos+e.del),a=cmEditor.getCursor(),s=cmEditor.getScrollInfo();cmEditor.replaceRange(e.ins,o,n,"remote"),cmEditor.setCursor(a),cmEditor.scrollTo(s.left,s.top),selectedFile&&(selectedFile.content=cmEditor.getValue())}finally{isApplyingRemoteOps=!1}}}async function snapshotFile(e){if(e&&e.is_syncable)try{const t=await hashPath(e.path),o=await encrypt(e.content);(await apiFetch("/api/room/"+roomId+"/files/"+t+"/snapshot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content_encrypted:o,through_seq:opSeq,metadata:generateMetadata()})})).ok&&console.log("Snapshot created for",e.path)}catch(e){console.error("Snapshot failed:",e)}}function startOpPolling(){stopOpPolling(),opPollInterval=setInterval(pollOps,1e3)}function stopOpPolling(){opPollInterval&&(clearInterval(opPollInterval),opPollInterval=null)}const SYNCABLE_EXT=new Set([".js",".ts",".jsx",".tsx",".mjs",".cjs",".py",".java",".kt",".go",".rs",".rb",".php",".swift",".c",".cpp",".h",".cs",".lua",".sh",".bash",".json",".yaml",".yml",".toml",".xml",".html",".htm",".css",".scss",".sass",".md",".mdx",".txt",".sql",".vue",".svelte",".env",".gitignore",".dockerfile"]),NEVER_SYNC_EXT=new Set([".jar",".exe",".dll",".so",".o",".a",".pyc",".wasm",".zip",".tar",".gz",".rar",".7z",".png",".jpg",".jpeg",".gif",".ico",".svg",".webp",".mp3",".mp4",".wav",".avi",".mov",".woff",".woff2",".ttf",".otf",".pdf",".doc",".docx",".xls",".xlsx",".ppt",".db",".sqlite",".pem",".key",".crt"]),NEVER_SYNC_DIRS=new Set(["node_modules",".git","dist","build","out","target","__pycache__",".next","vendor","venv",".venv","coverage",".idea",".vscode"]);let gitignorePatterns=[];function parseGitignore(e){const t=[];for(const o of e.split("\n")){const e=o.trim();if(e&&!e.startsWith("#"))try{let o=e,n=o.startsWith("!");n&&(o=o.slice(1));let a=o.endsWith("/");a&&(o=o.slice(0,-1)),o=o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=o.replace(/\\\*\\\*/g,".*"),o=o.replace(/\\\*/g,"[^/]*"),o=o.replace(/\\\?/g,"."),o=o.startsWith("\\/")?"^"+o.slice(2):"(^|/)"+o,o+=a?"(/|$)":"($|/)",t.push({regex:new RegExp(o),isNegation:n,isDir:a})}catch(t){console.warn("Invalid gitignore pattern:",e,t)}}return t}function isGitignored(e){let t=!1;for(const{regex:o,isNegation:n}of gitignorePatterns)o.test(e)&&(t=!n);return t}function getExtension(e){const t=e.split(".");return t.length>1?"."+t.pop().toLowerCase():""}function isInIgnoredDir(e){return e.split("/").some(e=>NEVER_SYNC_DIRS.has(e))}function isSyncable(e,t){if(isInIgnoredDir(e))return!1;const o=e.split("/").pop();if(".DS_Store"===o||"Thumbs.db"===o)return!1;if(isGitignored(e))return!1;const n=getExtension(e);if(NEVER_SYNC_EXT.has(n))return!1;if(SYNCABLE_EXT.has(n))return!0;if(t&&"string"==typeof t){const e=t.slice(0,8e3);let o=0;for(let t=0;t<e.length;t++){const n=e.charCodeAt(t);(n>=0&&n<=8||11===n||12===n||n>=14&&n<=31)&&o++}if(o/Math.min(t.length,8e3)>.1)return!1}return!0}function detectLanguage(e){return{".js":"javascript",".mjs":"javascript",".cjs":"javascript",".jsx":"javascript",".ts":"text/typescript",".tsx":"text/typescript",".py":"python",".java":"text/x-java",".kt":"text/x-kotlin",".cs":"text/x-csharp",".cpp":"text/x-c++src",".c":"text/x-csrc",".h":"text/x-c++hdr",".go":"go",".rs":"rust",".rb":"ruby",".php":"php",".swift":"swift",".sql":"sql",".html":"htmlmixed",".htm":"htmlmixed",".css":"css",".scss":"css",".json":"application/json",".yaml":"yaml",".yml":"yaml",".md":"markdown",".sh":"shell",".bash":"shell",".xml":"xml",".svg":"xml"}[getExtension(e)]||"text/plain"}async function hashPassword(e){if(!e)return"";const t=(new TextEncoder).encode(e),o=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(o)).map(e=>e.toString(16).padStart(2,"0")).join("")}async function apiFetch(e,t={}){await randomJitter(30,150);const o={...t.headers,...getDecoyHeaders()};roomPassword&&(o["X-Room-Password"]=roomPassword);let n=t.body;if(t.method&&["POST","PUT","PATCH"].includes(t.method.toUpperCase())&&n)try{const e=padPayload(JSON.parse(n));n=JSON.stringify(e)}catch(e){}const a=await fetch(e,{...t,headers:o,body:n});if(401===a.status&&(await a.json()).password_required)throw showPasswordModal(),new Error("Password required");return a}async function fetchRoomState(){let e=[],t=0,o=!0,n=null;for(;o;){const a=await apiFetch(API.roomState(0,50,t));if(!a.ok)throw new Error("Failed to fetch room chunk");const s=await a.json();let i;i={version:s.version,op_seq:s.op_seq,has_password:s.has_password,files:s.documents.map(e=>({id:e.id,path_hash:e.metadata?.refs?.[0],path_encrypted:e.title,content_encrypted:e.content,is_syncable:e.is_syncable,size_bytes:e.size_bytes,version:parseInt(e.metadata?.tracking?.utm_source)||1})),changesets:s.proposals||[],has_more:s.has_more},0===t&&(n=i),e.push(...i.files),o=i.has_more,t+=50,o&&(console.log(`Loaded ${e.length} files...`),await new Promise(e=>setTimeout(e,50)))}return n.files=e,n}async function checkRoomInfo(){const e=await fetch(API.roomInfo());if(!e.ok)throw new Error("Failed to get room info");const t=await e.json();return{id:t.workspace_id,has_password:t.requires_auth}}async function saveFile(e,t,o){void 0===o&&(o=!0);const n=await hashPath(e),a=await encrypt(e),s=o?await encrypt(t):null;let i;i={workspace_id:roomId,title:a,content:s,metadata:{refs:[n],tracking:{utm_source:"editor",utm_medium:"direct"}},is_syncable:o,size_bytes:o?null:t.length};const r=await apiFetch(API.files(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!r.ok)throw new Error("Failed to save file");return r.json()}async function deleteFile(e){if(!(await apiFetch("/api/room/"+roomId+"/files/"+e,{method:"DELETE"})).ok)throw new Error("Failed to delete file")}const CHUNK_TARGET_SIZE=153600,CHUNK_MIN_DELAY=200,CHUNK_MAX_DELAY=800;function randomDelay(){return 200+600*Math.random()}function generateMetadata(){const e=["sync","update","save","upload","push","commit"],t=["editor","browser","client","app","web","ui"];return{action:e[Math.floor(Math.random()*e.length)],source:t[Math.floor(Math.random()*t.length)],client_version:"1.0.0",platform:navigator.platform||"web",locale:navigator.language||"en-US",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,screen:`${window.screen.width}x${window.screen.height}`,timestamp:(new Date).toISOString(),user_agent_hash:btoa(navigator.userAgent.slice(0,20)).slice(0,12)}}function generateRequestId(){return"req_"+Date.now().toString(36)+Math.random().toString(36).slice(2,8)}function generateClientId(){let e=sessionStorage.getItem("livepaste_client_id");return e||(e="client_"+Date.now().toString(36)+Math.random().toString(36).slice(2,10),sessionStorage.setItem("livepaste_client_id",e)),e}async function encryptBatch(e){return await Promise.all(e.map(async e=>{const t={path_hash:await hashPath(e.path),path_encrypted:await encrypt(e.path),content_encrypted:e.is_syncable?await encrypt(e.content):null,is_syncable:e.is_syncable,size_bytes:e.is_syncable?null:e.size};return e.content=null,t}))}async function uploadChunk(e,t,o){let n;n={workspace_id:roomId,session_token:e,batch_index:t,documents:o.map(e=>({id:e.path_hash,title:e.path_encrypted,content:e.content_encrypted,metadata:{refs:[e.path_hash],tracking:{utm_source:"sync",utm_campaign:generateRequestId()}},is_syncable:e.is_syncable,size_bytes:e.size_bytes}))};const a=await apiFetch(API.syncChunk(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!a.ok)throw new Error(`Failed to upload chunk ${t+1}`);return a.json()}async function streamingSyncFiles(e,t){let o;o={client_id:generateClientId(),batch_count:-1,document_count:-1};const n=await apiFetch(API.syncBegin(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!n.ok)throw new Error("Failed to begin sync");const a=(await n.json()).session_token;let s,i=0,r=0,c=0,l=[],d=0;for await(const o of e){const e=await encryptBatch(o);for(const o of e){const e=JSON.stringify(o).length;d+e>153600&&l.length>0&&(i>0&&await new Promise(e=>setTimeout(e,randomDelay())),await uploadChunk(a,i,l),c+=l.length,i++,t&&t({chunksUploaded:i,filesUploaded:c,filesProcessed:r}),l=[],d=0),l.push(o),d+=e,r++}}l.length>0&&(i>0&&await new Promise(e=>setTimeout(e,randomDelay())),await uploadChunk(a,i,l),c+=l.length,i++,t&&t({chunksUploaded:i,filesUploaded:c,filesProcessed:r})),await new Promise(e=>setTimeout(e,randomDelay())),s={session_token:a};const p=await apiFetch(API.syncComplete(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!p.ok)throw new Error("Failed to complete sync");return console.log(`Streaming sync complete: ${r} files in ${i} chunks`),p.json()}async function syncFiles(e){return streamingSyncFiles(async function*(){for(let t=0;t<e.length;t+=30)yield e.slice(t,t+30)}(),({filesUploaded:t})=>{showToast(`Syncing... ${Math.round(t/e.length*100)}%`)})}let pollInterval=null;async function poll(){if(!(isPolling||Date.now()-lastActivityTime<2e3)){isPolling=!0;try{const e=await apiFetch(API.roomVersion());if(!e.ok)throw new Error("Version check failed");const t=await e.json();if((t.revision??t.version)>version){const e=await apiFetch(API.roomState(version)),t=await e.json();await applyState(t)}setStatus(!0)}catch(e){"Password required"===e.message?stopPolling():(console.error("Poll error:",e),setStatus(!1))}finally{isPolling=!1}}}function stopPolling(){pollInterval&&(clearInterval(pollInterval),pollInterval=null)}function startPolling(){pollInterval&&clearInterval(pollInterval),pollInterval=setInterval(poll,2e3)}async function applyState(e){version=e.version,document.getElementById("versionBadge").textContent=version,void 0!==e.op_seq&&(opSeq=e.op_seq);const t=await Promise.all(e.files.map(async e=>({...e,path:await decrypt(e.path_encrypted),content:e.is_syncable?await decrypt(e.content_encrypted):null})));for(const e of t){const t=files.findIndex(t=>t.path_hash===e.path_hash);-1!==t?files[t]=e:files.push(e)}if(e.deleted_path_hashes&&e.deleted_path_hashes.length>0){const t=new Set(e.deleted_path_hashes),o=files.filter(e=>t.has(e.path_hash)).map(e=>e.path);files=files.filter(e=>!t.has(e.path_hash)),selectedFile&&t.has(selectedFile.path_hash)&&(console.log(`Selected file "${selectedFile.path}" was deleted by another client`),selectedFile=null,showEmptyState()),o.length>0&&console.log(`Delta sync: ${o.length} file(s) deleted by other clients`)}if(changesets=await Promise.all((e.changesets||[]).map(async e=>({...e,author:await decrypt(e.author_encrypted),message:await decrypt(e.message_encrypted),changes:await Promise.all((e.changes||[]).map(async e=>({...e,file_path:await decrypt(e.file_path_encrypted),old_content:e.old_content_encrypted?await decrypt(e.old_content_encrypted):"",new_content:await decrypt(e.new_content_encrypted),diff:e.diff_encrypted?await decrypt(e.diff_encrypted):""})))}))),renderFileTree(),updateChangesetBanner(),selectedFile){const e=files.find(e=>e.path===selectedFile.path);if(e&&e.version!==selectedFile.version&&e.is_syncable){const t=cmEditor?cmEditor.getCursor():null,o=cmEditor?cmEditor.getScrollInfo():null;selectFile(e),cmEditor&&t&&(cmEditor.setCursor(t),cmEditor.scrollTo(o.left,o.top))}}}let fileSearchQuery="";const collapsedFolders=new Set;function filterFiles(){fileSearchQuery=document.getElementById("fileSearch").value.toLowerCase(),renderFileTree()}function toggleFolder(e){collapsedFolders.has(e)?collapsedFolders.delete(e):collapsedFolders.add(e),renderFileTree()}function getAllFolderPaths(){const e=new Set;for(const t of files){const o=t.path.split("/");let n="";for(let t=0;t<o.length-1;t++)n=n?n+"/"+o[t]:o[t],e.add(n)}return e}function expandAll(){collapsedFolders.clear(),renderFileTree()}function collapseAll(){const e=getAllFolderPaths();for(const t of e)collapsedFolders.add(t);renderFileTree()}function renderFileTree(){const e=fileSearchQuery,t=e?files.filter(t=>t.path.toLowerCase().includes(e)):files,o={};for(const e of t){const t=e.path.split("/");let n=o;for(let e=0;e<t.length-1;e++)n[t[e]]||(n[t[e]]={_isDir:!0}),n=n[t[e]];n[t[t.length-1]]=e}function n(e,t,o){const a=(o=o||"")?o+"/"+t:t;if(e._isDir){const o=Object.entries(e).filter(e=>"_isDir"!==e[0]),s=1===o.length&&o[0][1]._isDir,i=collapsedFolders.has(a)&&!s;return`<div class="tree-item folder" onclick="toggleFolder('${a}')"><span class="icon">${i?"&#128193;":"&#128194;"}</span><span class="name">${t}</span></div><div class="tree-children ${i?"hidden":""}">${o.map(e=>n(e[1],e[0],a)).join("")}</div>`}const s=e,i=selectedFile&&selectedFile.id===s.id,r=changesets.some(e=>e.changes.some(e=>e.file_path===s.path&&"pending"===e.status));return`<div class="tree-item ${i?"selected":""} ${s.is_syncable?"":"non-syncable"}" onclick="selectFileById('${s.id}')"><span class="icon">${s.is_syncable?"&#128196;":"&#9675;"}</span><span class="name">${t}${r?" [!]":""}</span>${!s.is_syncable&&s.size_bytes?`<span class="size">${formatSize(s.size_bytes)}</span>`:""}</div>`}const a=Object.entries(o),s=document.getElementById("fileTree"),i=s.scrollTop;s.innerHTML=a.length?a.map(e=>n(e[1],e[0])).join(""):`<div style="padding:1rem;color:var(--muted);text-align:center">${e?"No matches":"No files yet"}</div>`,s.scrollTop=i}function formatSize(e){return e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB"}function selectFileById(e){const t=files.find(t=>t.id===e);t&&selectFile(t)}function selectFile(e){pendingOps.length>0&&sendPendingOps(),stopOpPolling(),selectedFile=e,renderFileTree(),document.getElementById("fileHeader").textContent=e.path,document.getElementById("emptyState").classList.add("hidden");const t=changesets.flatMap(e=>e.changes).find(t=>t.file_path===e.path&&"pending"===t.status);t?showDiffView(t):e.is_syncable?showEditor(e):showNonSyncable(e)}function showEditor(e){document.getElementById("diffView").classList.add("hidden");const t=document.getElementById("editorWrapper");t.classList.remove("hidden");const o=detectLanguage(e.path),n=e.content||"";if(cmEditor){if(cmEditor.getValue()!==n){isApplyingRemoteOps=!0;const e=cmEditor.getScrollInfo(),t=cmEditor.getCursor();cmEditor.setValue(n),cmEditor.scrollTo(e.left,e.top),cmEditor.setCursor(t),isApplyingRemoteOps=!1}cmEditor.setOption("mode",o)}else cmEditor=CodeMirror(t,{value:n,mode:o,theme:"material-darker",lineNumbers:!0,tabSize:2,indentWithTabs:!1,lineWrapping:!0,matchBrackets:!0,autoCloseBrackets:!0}),cmEditor.on("change",handleEditorChange),cmEditor.on("change",captureLocalOp);cmEditor.refresh(),e.is_syncable&&startOpPolling()}function showDiffView(e){document.getElementById("editorWrapper").classList.add("hidden"),document.getElementById("diffView").classList.remove("hidden");const t=(e.diff||Diff.createPatch(e.file_path,e.old_content,e.new_content)).split("\n").map(e=>{let t="";return"+"===e.charAt(0)&&"+++"!==e.substring(0,3)?t="added":"-"===e.charAt(0)&&"---"!==e.substring(0,3)?t="removed":"@@"===e.substring(0,2)&&(t="header"),`<div class="diff-line ${t}">${escapeHtml(e)}</div>`}).join("");document.getElementById("diffView").innerHTML=`<div class="change-card"><div class="change-card-header"><span class="path">${e.file_path}</span><div class="change-card-actions"><button class="btn" onclick="acceptChange('${e.id}')">&check; Accept</button><button class="btn btn-secondary" onclick="rejectChange('${e.id}')">&times; Reject</button></div></div>${t}</div>`}function showNonSyncable(e){document.getElementById("editorWrapper").classList.add("hidden"),document.getElementById("diffView").classList.remove("hidden"),document.getElementById("diffView").innerHTML=`<div style="padding:2rem;text-align:center;color:var(--muted)"><p>&#9675; This file is only available on the source machine.</p><p style="margin-top:0.5rem">Size: ${formatSize(e.size_bytes||0)}</p></div>`}function showEmptyState(){document.getElementById("fileHeader").textContent="No file selected",document.getElementById("emptyState").classList.remove("hidden"),document.getElementById("editorWrapper").classList.add("hidden"),document.getElementById("diffView").classList.add("hidden")}function updateChangesetBanner(){const e=changesets.filter(e=>"pending"===e.status),t=document.getElementById("changesetBanner");if(e.length>0){const o=e[0],n=o.changes.filter(e=>"pending"===e.status).length;document.getElementById("changesetMessage").textContent=`${o.author||"Someone"} proposed ${n} change(s): "${o.message||"No message"}"`,t.classList.remove("hidden")}else t.classList.add("hidden")}function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function setStatus(e){const t=document.getElementById("statusDot"),o=document.getElementById("statusText");e?(t.classList.remove("offline"),o.textContent="Online"):(t.classList.add("offline"),o.textContent="Reconnecting...")}function showToast(e,t="success"){const o=document.createElement("div");o.className=`toast ${t}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>o.remove(),3e3)}function handleEditorChange(){selectedFile&&selectedFile.is_syncable&&cmEditor&&(lastActivityTime=Date.now(),clearTimeout(saveTimeout),saveTimeout=setTimeout(async()=>{const e=cmEditor.getValue();if(e!==selectedFile.content)try{await saveFile(selectedFile.path,e),selectedFile.content=e,showToast("Saved")}catch(e){showToast("Save failed","error")}},500))}function copyCode(){selectedFile&&(navigator.clipboard.writeText(selectedFile.content||""),showToast("Copied to clipboard"))}function copyRoomUrl(){navigator.clipboard.writeText(window.location.href),showToast("URL copied to clipboard")}let qrCodeInstance=null;function showQRCode(){const e=window.location.href,t=document.getElementById("qrCode");t.innerHTML="",qrCodeInstance=new QRCode(t,{text:e,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M}),document.getElementById("qrUrlDisplay").textContent=e,document.getElementById("qrModal").classList.remove("hidden")}function hideQRCode(){document.getElementById("qrModal").classList.add("hidden")}async function downloadAll(){const e=new JSZip;for(const t of files)t.is_syncable&&t.content&&e.file(t.path,t.content);const t=await e.generateAsync({type:"blob"}),o=URL.createObjectURL(t),n=document.createElement("a");n.href=o,n.download=`livepaste-${roomId}.zip`,n.click(),URL.revokeObjectURL(o)}function showAddFileModal(){document.getElementById("addFileModal").classList.remove("hidden"),document.getElementById("newFilePath").focus()}function hideAddFileModal(){document.getElementById("addFileModal").classList.add("hidden"),document.getElementById("newFilePath").value=""}async function createNewFile(){const e=document.getElementById("newFilePath").value.trim();if(e)try{await saveFile(e,""),hideAddFileModal(),showToast("File created")}catch(e){showToast("Failed to create file","error")}}function uploadFolder(){"showDirectoryPicker"in window?uploadFolderNative():document.getElementById("folderInput").click()}async function uploadFolderNative(){try{dirHandle=await window.showDirectoryPicker(),document.getElementById("saveToDiskBtn").style.display="block",gitignorePatterns=[];try{const e=await dirHandle.getFileHandle(".gitignore"),t=await e.getFile(),o=await t.text();gitignorePatterns=parseGitignore(o),console.log(`Loaded ${gitignorePatterns.length} gitignore patterns`)}catch(e){console.log("No .gitignore found, continuing without it")}const e=20;let t=0,o=0;console.log("Starting streaming folder upload..."),showToast("Scanning and uploading...");const n=await streamingSyncFiles(async function*(n,a=""){let s=[];yield*async function*n(a,i){for await(const r of a.values()){const a=i?i+"/"+r.name:r.name;try{if("directory"===r.kind)NEVER_SYNC_DIRS.has(r.name)||isGitignored(a+"/")?t++:yield*n(r,a);else if(isSyncable(a,null)){const t=await r.getFile(),n=await t.text();s.push({path:a,content:n,is_syncable:!0}),o++,s.length>=e&&(yield s,s=[])}else t++}catch(e){console.warn(`Skipping ${a}: ${e.message}`),t++}}}(n,a),s.length>0&&(yield s)}(dirHandle),({filesUploaded:e,chunksUploaded:t})=>{showToast(`Uploading... ${e} files (${t} chunks)`)});if(0===o)return void showToast("No syncable files found","error");let a=n;n.documents&&(a={version:n.version,op_seq:n.op_seq,files:n.documents.map(e=>({id:e.id,path_hash:e.metadata?.refs?.[0],path_encrypted:e.title,content_encrypted:e.content,is_syncable:e.is_syncable,size_bytes:e.size_bytes,version:parseInt(e.metadata?.tracking?.utm_source)||1})),changesets:n.proposals||[]}),await applyState(a),console.log(`Streaming upload complete: ${o} files, ${t} skipped`),showToast(`Uploaded ${o} files (${t} skipped)`)}catch(e){"AbortError"!==e.name&&(console.error("Folder upload error:",e),showToast(`Upload failed: ${e.message}`,"error"))}}async function handleFolderUpload(e){const t=e.target.files;if(!t.length)return;let o=0,n=0;showToast("Uploading...");const a=await streamingSyncFiles(async function*(){let e=[];for(const a of t){const t=a.webkitRelativePath||a.name;if(isInIgnoredDir(t))n++;else if(isSyncable(t,null)){const n=await a.text();e.push({path:t,content:n,is_syncable:!0}),o++,e.length>=20&&(yield e,e=[])}else n++}e.length>0&&(yield e)}(),({filesUploaded:e})=>{showToast(`Uploading... ${e} files`)});await applyState(a),showToast(`Uploaded ${o} files (${n} skipped)`),e.target.value=""}async function saveToDisk(){if(dirHandle)try{for(const e of files){if(!e.is_syncable||!e.content)continue;const t=e.path.split("/");let o=dirHandle;for(let e=0;e<t.length-1;e++)o=await o.getDirectoryHandle(t[e],{create:!0});const n=await o.getFileHandle(t[t.length-1],{create:!0}),a=await n.createWritable();await a.write(e.content),await a.close()}showToast("Saved to disk")}catch(e){console.error("Save to disk error:",e),showToast("Save failed","error")}}async function acceptAllChanges(){const e=changesets.find(e=>"pending"===e.status);if(e)try{await apiFetch(`/api/room/${roomId}/changesets/${e.id}/accept`,{method:"POST"}),showToast("Changes accepted")}catch(e){showToast("Failed to accept","error")}}async function rejectAllChanges(){const e=changesets.find(e=>"pending"===e.status);if(e)try{await apiFetch(`/api/room/${roomId}/changesets/${e.id}/reject`,{method:"POST"}),showToast("Changes rejected")}catch(e){showToast("Failed to reject","error")}}async function acceptChange(e){try{await apiFetch(`/api/room/${roomId}/changes/${e}/accept`,{method:"POST"}),showToast("Change accepted")}catch(e){showToast("Failed to accept","error")}}async function rejectChange(e){try{await apiFetch(`/api/room/${roomId}/changes/${e}/reject`,{method:"POST"}),showToast("Change rejected")}catch(e){showToast("Failed to reject","error")}}function initSidebarResize(){const e=document.getElementById("sidebar"),t=document.getElementById("sidebarResize");let o=!1;t.addEventListener("mousedown",e=>{o=!0,t.classList.add("dragging"),document.body.style.cursor="ew-resize",document.body.style.userSelect="none",e.preventDefault()}),document.addEventListener("mousemove",t=>{if(!o)return;const n=t.clientX;n>=150&&n<=600&&(e.style.width=n+"px")}),document.addEventListener("mouseup",()=>{o&&(o=!1,t.classList.remove("dragging"),document.body.style.cursor="",document.body.style.userSelect="")})}function showPasswordModal(){document.getElementById("passwordModal").classList.remove("hidden"),document.getElementById("passwordInput").focus(),document.getElementById("passwordError").style.display="none"}function hidePasswordModal(){document.getElementById("passwordModal").classList.add("hidden"),document.getElementById("passwordInput").value=""}async function submitPassword(){const e=document.getElementById("passwordInput").value;if(e)try{const t=await hashPassword(e);if((await fetch("/api/room/"+roomId+"/verify-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t})})).ok){roomPassword=t,sessionStorage.setItem("room_password_"+roomId,roomPassword),hidePasswordModal();const e=await fetchRoomState();await applyState(e),startPolling(),showToast("Access granted")}else document.getElementById("passwordError").textContent="Incorrect password",document.getElementById("passwordError").style.display="block"}catch(e){document.getElementById("passwordError").textContent="Error verifying password",document.getElementById("passwordError").style.display="block"}}function showSetPasswordModal(){document.getElementById("setPasswordModal").classList.remove("hidden"),document.getElementById("setPasswordInput").focus(),document.getElementById("setPasswordError").style.display="none"}function hideSetPasswordModal(){document.getElementById("setPasswordModal").classList.add("hidden"),document.getElementById("setPasswordInput").value="",document.getElementById("setPasswordConfirm").value=""}async function setRoomPassword(){const e=document.getElementById("setPasswordInput").value,t=document.getElementById("setPasswordConfirm").value,o=document.getElementById("setPasswordError");if(e.length<4)return o.textContent="Password must be at least 4 characters",void(o.style.display="block");if(e!==t)return o.textContent="Passwords do not match",void(o.style.display="block");try{const t=await hashPassword(e),n=await fetch("/api/room/"+roomId+"/password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t,current_password:roomPassword})});if(n.ok)roomPassword=t,sessionStorage.setItem("room_password_"+roomId,roomPassword),hasPassword=!0,updatePasswordUI(),hideSetPasswordModal(),showToast("Password set successfully");else{const e=await n.json();o.textContent=e.error||"Failed to set password",o.style.display="block"}}catch(e){o.textContent="Error setting password",o.style.display="block"}}async function confirmKillRoom(){if(confirm("Are you sure you want to PERMANENTLY delete this room and all its files? This cannot be undone."))try{(await apiFetch("/api/room/"+roomId,{method:"DELETE"})).ok?(alert("Room deleted."),window.location.href="/"):showToast("Failed to delete room","error")}catch(e){showToast("Error deleting room","error")}}function updatePasswordUI(){const e=document.getElementById("passwordStatus"),t=document.getElementById("passwordBtn");hasPassword?(e.style.display="inline",e.title="Room is password protected",t.title="Change room password"):(e.style.display="none",t.title="Set room password")}function showAddDirModal(){document.getElementById("addDirModal").classList.remove("hidden"),document.getElementById("newDirPath").focus()}function hideAddDirModal(){document.getElementById("addDirModal").classList.add("hidden"),document.getElementById("newDirPath").value=""}async function createNewDir(){let e=document.getElementById("newDirPath").value.trim();if(!e)return;e.endsWith("/")&&(e=e.slice(0,-1));const t=e+"/.gitkeep";try{await saveFile(t,""),hideAddDirModal(),showToast("Directory created")}catch(e){showToast("Failed to create directory","error")}}let isolationIndicators=[],isolationConfidence="unknown",hasRunComprehensive=!1;function detectBrowserIsolation(){const e=[],t={};try{window.self!==window.top&&(e.push("Running in iframe"),t.iframe=1)}catch(o){e.push("Cross-origin frame detected"),t.cross_origin=2}const o=navigator.userAgent.toLowerCase(),n=["menlo","fireglass","symantec","zscaler","netskope","proofpoint","forcepoint","ericom","citrix","cloudflare","browserling","browserstack","authentic8","island"];for(const a of n)o.includes(a)&&(e.push("Isolation proxy UA: "+a),t["ua_"+a]=3);try{"mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices||(e.push("Screen capture API missing"),t.screencapture=1)}catch(o){e.push("MediaDevices restricted"),t.mediadevices=1}document.querySelectorAll('script[src*="isolation"], script[src*="menlo"], script[src*="zscaler"], script[src*="netskope"]').length>0&&(e.push("Injected isolation scripts"),t.injected_scripts=2),(window.__isolation__||window.__menlo__||window.__zscaler__||window.__netskope__)&&(e.push("Isolation global variables"),t.isolation_global=3);const a=Object.values(t).reduce((e,t)=>e+t,0);a>=5?isolationConfidence="high":a>=4?isolationConfidence="medium":a>=3&&(isolationConfidence="low"),isolationIndicators=e,a>=3&&(console.warn("Browser isolation detected (passive):",e),showIsolationWarning())}async function runComprehensiveIsolationCheck(){if(hasRunComprehensive)return void showIsolationDetails();showToast("Running isolation analysis...","info");const e=[...isolationIndicators],t={};e.some(e=>e.includes("Cross-origin"))&&(t.cross_origin=2),e.some(e=>e.includes("iframe"))&&(t.iframe=1),e.filter(e=>e.includes("Isolation proxy UA")).forEach(e=>{t["ua_"+e.split(": ")[1]]=3});try{const o=await measureFrameLatency();o>40&&(e.push("High frame latency: "+o.toFixed(1)+"ms"),t.frame_latency=o>100?3:2)}catch(e){}try{const{variance:o,avgDelta:n}=await measureFrameTimingVariance();o<.5&&n>20?(e.push("Suspiciously consistent frame timing (variance: "+o.toFixed(2)+")"),t.frame_variance=2):n>25&&(e.push("High average frame delta: "+n.toFixed(1)+"ms"),t.frame_delta=2)}catch(e){}try{const o=checkForVirtualGPU();o.isVirtual&&(e.push("Virtual GPU: "+o.renderer),t.virtual_gpu=3)}catch(e){}try{getCanvasFingerprint()<1e3&&(e.push("Low canvas complexity (possible compression)"),t.canvas=2)}catch(e){}try{const o=await measureNetworkRTT();o>100&&(e.push("High network RTT: "+o.toFixed(0)+"ms"),t.network_rtt=o>200?3:2)}catch(e){}try{await checkWebRTCRestricted()&&(e.push("WebRTC restricted"),t.webrtc=2)}catch(o){e.push("WebRTC blocked"),t.webrtc=2}try{localStorage.setItem("__isolation_test__","1"),localStorage.removeItem("__isolation_test__")}catch(o){e.push("Local storage restricted"),t.localstorage=2}try{navigator.clipboard&&navigator.clipboard.writeText||(e.push("Clipboard API unavailable"),t.clipboard=1)}catch(o){e.push("Clipboard API restricted"),t.clipboard=1}const o=Object.values(t).reduce((e,t)=>e+t,0),n=o>=4;isolationConfidence=o>=8?"high":o>=6?"medium":o>=4?"low":"unknown";let a="none";n&&(a=t.frame_latency>=2||t.frame_variance>=2?"pixel-streaming":t.virtual_gpu>=2?"virtual-machine":"rbi"),isolationIndicators=e,hasRunComprehensive=!0,n&&(console.warn("Browser isolation detected (comprehensive):",e,"Type:",a),showIsolationWarning()),showIsolationDetails()}function showIsolationWarning(){const e=document.getElementById("isolationWarning");e.style.display="inline";const t="unknown"!==isolationConfidence?" ("+isolationConfidence+" confidence)":"";e.title="Browser isolation detected"+t+" - click for details"}function showIsolationDetails(){const e=isolationIndicators.length>0?isolationIndicators.join("\n "):"No isolation indicators detected";alert((hasRunComprehensive?"Comprehensive analysis:\n ":"Passive detection:\n ")+e+"\n\nConfidence: "+isolationConfidence)}function measureFrameLatency(){return new Promise(e=>{const t=performance.now();requestAnimationFrame(()=>{e(performance.now()-t)})})}function measureFrameTimingVariance(){return new Promise(e=>{const t=[];let o=performance.now(),n=0;requestAnimationFrame(function a(s){const i=s-o;if(t.push(i),o=s,n++,n<30)requestAnimationFrame(a);else{const o=t.reduce((e,t)=>e+t)/t.length,n=t.reduce((e,t)=>e+Math.pow(t-o,2),0)/t.length;e({variance:n,avgDelta:o})}})})}function checkForVirtualGPU(){const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return{isVirtual:!1,renderer:"unknown"};const o=t.getExtension("WEBGL_debug_renderer_info");if(!o)return{isVirtual:!1,renderer:"unknown"};const n=t.getParameter(o.UNMASKED_RENDERER_WEBGL),a=t.getParameter(o.UNMASKED_VENDOR_WEBGL),s=(a+" "+n).toLowerCase();return{isVirtual:["swiftshader","vmware","virtualbox","parallels","nvidia grid","microsoft basic render driver","llvmpipe","virgl","qemu"].some(e=>new RegExp("\\b"+e.replace(/\s+/g,"\\s+")+"\\b","i").test(s)),renderer:a+" "+n}}function getCanvasFingerprint(){const e=document.createElement("canvas");e.width=200,e.height=50;const t=e.getContext("2d");if(!t)return 1e4;t.fillStyle="rgb(255, 0, 0)",t.fillRect(0,0,100,50);const o=t.createLinearGradient(0,0,200,50);return o.addColorStop(0,"blue"),o.addColorStop(1,"green"),t.fillStyle=o,t.fillRect(100,0,100,50),t.font="18px Arial",t.fillStyle="white",t.fillText("Test123",10,30),e.toDataURL().length}async function measureNetworkRTT(){const e=performance.now();try{await fetch(window.location.origin+"?t="+Date.now(),{method:"HEAD",cache:"no-store",mode:"same-origin"})}catch(e){return 0}return performance.now()-e}async function checkWebRTCRestricted(){return new Promise(e=>{try{const t=new RTCPeerConnection({iceServers:[]});t.createDataChannel(""),t.createOffer().then(e=>t.setLocalDescription(e)).then(()=>{t.close(),e(!1)}).catch(()=>{t.close(),e(!0)}),setTimeout(()=>{t.close(),e(!1)},500)}catch(t){e(!0)}})}function startFakeSync(){setInterval(()=>{Math.random()>.7||apiFetch("/api/workspace/sync",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cursor:generateClientId(),type:"keepalive"})}).catch(()=>{})},25e3+2e4*Math.random())}async function init(){await initEncryption(),detectBrowserIsolation(),startFakeSync();try{const e=await checkRoomInfo();if(hasPassword=e.has_password,updatePasswordUI(),hasPassword&&!roomPassword)return void showPasswordModal()}catch(e){console.error("Failed to check room info:",e)}try{const e=await fetchRoomState();hasPassword=e.has_password||!1,updatePasswordUI(),await applyState(e),initSidebarResize(),startPolling()}catch(e){"Password required"===e.message?showPasswordModal():(console.error("Init error:",e),showToast("Failed to load room","error"))}}init().catch(console.error);</script></body></html>